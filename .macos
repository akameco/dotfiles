#!/usr/bin/env bash
set -euo pipefail

# System Settings を閉じる（defaults 反映の邪魔になりがち）
osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true

if ! xcode-select -p >/dev/null 2>&1; then
  echo "Installing Xcode Command Line Tools…"
  xcode-select --install || {
    echo "インストーラが完了したら再実行してください"
    exit 1
  }
  read -rp "インストール完了後に Enter を押してください…" _
fi

sudo -v
# sudo keep-alive
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# カスタマイズ
echo "Hello ${whoami}! Let's get you set up"

echo "installing homebrew"
# install homebrew https://brew.sh
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

brew install git gh

# ここにghの設定が必要
DEV_DIR="${HOME}/dev/github.com/akameco"
DOT_DIR="${DEV_DIR}/dotfiles"

echo "${DEV_DIR}"
mkdir -p "${DEV_DIR}"

if [ ! -d "${DOT_DIR}" ]; then
  echo "cloning dotfiles with gh"
  gh repo clone akameco/dotfiles "${DOT_DIR}"
else
  echo "dotfiles repo already exists at ${DOT_DIR}"
fi

echo "cd ${DOT_DIR}"
cd "${DOT_DIR}"

echo "brew bundle"
brew bundle --global

ln -s "${DOT_DIR}/.zshenv" "${HOME}/.zshenv"
ln -s "${DOT_DIR}/config" "${HOME}/.config"

git config --global commit.template "${HOME}/.config/git/gitmessage"
git config --global core.hooksPath "${HOME}/.config/git/hooks"

GHOSTTY_CONFIG_DIR="${HOME}/Library/Application Support/com.mitchellh.ghostty"
mkdir -p "${GHOSTTY_CONFIG_DIR}"
ln -sf "${DOT_DIR}/config/ghostty/config" "${GHOSTTY_CONFIG_DIR}/config"

###############################################################################
# 入力・キーボード・トラックパッド
###############################################################################
# タップでクリック（ログイン画面含む）
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# 右クリック有効
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true

# キーリピート高速化（値は好みで調整）
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# コード向け：スマート系を無効化
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

###############################################################################
# スクリーン・セキュリティ・スクリーンショット
###############################################################################
# すぐにパスワード要求
defaults write com.apple.screensaver askForPassword -int 1
defaults write com.apple.screensaver askForPasswordDelay -int 0

# スクショ保存先/形式
mkdir -p "$HOME/Screenshots"
defaults write com.apple.screencapture location -string "$HOME/Screenshots"
defaults write com.apple.screencapture type -string "png"
# 影を付けない（必要なら）
# defaults write com.apple.screencapture disable-shadow -bool true

###############################################################################
# Finder
###############################################################################
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder NewWindowTarget -string "PfHm"
defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/"
chflags nohidden "$HOME/Library" || true

# ネットワーク/USBで .DS_Store を作らない
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

###############################################################################
# Dock
###############################################################################
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock tilesize -int 70
# 最近使ったアプリを隠す
defaults write com.apple.dock show-recents -bool false
# （お好みで）アニメ短縮
# defaults write com.apple.dock launchanim -bool false
defaults write com.apple.dock persistent-apps -array


###############################################################################
# Photos（デバイス接続で自動起動しない）
###############################################################################
defaults -currentHost write com.apple.ImageCapture disableHotPlug -bool true

###############################################################################
# ブラウザ（Chrome）
###############################################################################
defaults write com.google.Chrome AppleEnableSwipeNavigateWithScrolls -bool false
defaults write com.google.Chrome PMPrintingExpandedStateForPrint2 -bool true

# 反映
killall Finder 2>/dev/null || true
killall Dock 2>/dev/null || true
killall SystemUIServer 2>/dev/null || true
echo "Done. 必要に応じてログアウト/再起動で完全反映します。"
